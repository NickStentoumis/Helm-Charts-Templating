# Helm Template Refactoring Tool

A Python-based tool that refactors Helm templates generated by [Helmify](https://github.com/arttor/helmify) to reduce code duplication by creating reusable base templates.

## Purpose

When using Helmify to convert Kubernetes manifests to Helm charts, the output often contains significant code duplication across services. This tool analyzes these templates, extracts common patterns, and generates:
- Base templates for common resource types
- Refactored service templates that reference the base templates
- Up to 90% reduction in template code

## Project Structure (Draft)

```
helm-template-refactoring/
│
├── main.py                     # Main entry point
├── requirements.txt            # Python dependencies
├── README.md                   # This file
│
├── models/                     # Domain models for K8s resources
│   ├── __init__.py            
│   ├── base.py                # Abstract base classes
│   ├── deployment.py          # Deployment model
│   ├── service.py             # Service model
│   └── service_account.py     # ServiceAccount model
│
├── parsers/                    # YAML/Helm template parsers
│   ├── __init__.py            
│   ├── base_parser.py         # Base parser with Helm template support
│   ├── deployment_parser.py   # Deployment-specific parsing
│   ├── service_parser.py      # Service-specific parsing
│   └── service_account_parser.py
│
├── extractors/                 # Pattern extraction logic
│   ├── __init__.py            
│   └── pattern_extractor.py   # Analyzes resources for common patterns
│
├── generators/                 # Template generation
│   ├── __init__.py            
│   ├── base_template_generator.py      # Creates base templates
│   └── refactored_template_generator.py # Creates refactored services
│
├── utils/                      # Utility functions
│   ├── __init__.py            
│   └── yaml_utils.py          # YAML processing utilities
│
├── validate.py                 # Validation script (optional)
│
└── tests/                      # Test scripts (draft)
    ├── test_parser.py         
    └── test_integration.py    
```

> **Note**: This is a draft structure. Some components may be refactored as the project evolves.

## Installation

### Prerequisites
- Python 3.8 or higher
- Helm 3.x (for validation only)

2. Install dependencies:


### Dependencies
- `PyYAML>=6.0` - YAML parsing
- `Jinja2>=3.1.0` - Template generation

## Usage

### Basic Usage

```bash
python main.py <input_directory> <output_directory>
```

### Example

```bash
# Process Helmify output
python main.py ./helmify-output ./refactored-chart

# With debug output
python main.py ./helmify-output ./refactored-chart --debug
```

### Input Requirements

The input directory should contain Helmify-generated files:
- `*.yaml` - Service templates (e.g., `adservice.yaml`, `frontend.yaml`)
- `values.yaml` - Helm values file
- `Chart.yaml` - Chart metadata

### Output Structure

```
refactored-chart/
├── Chart.yaml                    # Original chart metadata
├── values.yaml                   # Original values (unchanged)
└── templates/
    ├── _helpers-microservice.yaml # Helper templates
    ├── _base/                    # Base templates
    │   ├── deployment.yaml
    │   ├── service.yaml
    │   └── serviceaccount.yaml
    └── <service-name>.yaml       # Refactored services
```

## How It Works

### 1. **Parsing Phase**
- Reads Helmify-generated YAML files
- Handles Helm template syntax (e.g., `{{ .Values.something }}`)
- Creates domain model objects

### 2. **Pattern Extraction Phase**
- Analyzes all parsed resources
- Identifies common patterns:
  - Security contexts
  - Resource limits
  - Container configurations
  - Probe definitions
  - Environment variables

### 3. **Template Generation Phase**
- Creates base templates for common patterns
- Generates refactored service templates
- Maintains compatibility with original `values.yaml`

### 4. **Output Phase**
- Writes base templates to `_base/` directory
- Creates simplified service files
- Preserves original chart structure